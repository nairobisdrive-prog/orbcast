{"dependencies":[],"output":[{"data":{"code":"__d(function(g,r,i,a,_m,e,d){\"use strict\";var n;Object.defineProperty(e,\"__esModule\",{value:!0}),e.REALTIME_PRESENCE_LISTEN_EVENTS=void 0,(function(n){n.SYNC=\"sync\",n.JOIN=\"join\",n.LEAVE=\"leave\"})(n||(e.REALTIME_PRESENCE_LISTEN_EVENTS=n={}));class t{constructor(n,s){this.channel=n,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const c=(null==s?void 0:s.events)||{state:'presence_state',diff:'presence_diff'};this.channel._on(c.state,{},n=>{const{onJoin:s,onLeave:c,onSync:o}=this.caller;this.joinRef=this.channel._joinRef(),this.state=t.syncState(this.state,n,s,c),this.pendingDiffs.forEach(n=>{this.state=t.syncDiff(this.state,n,s,c)}),this.pendingDiffs=[],o()}),this.channel._on(c.diff,{},n=>{const{onJoin:s,onLeave:c,onSync:o}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(n):(this.state=t.syncDiff(this.state,n,s,c),o())}),this.onJoin((n,t,s)=>{this.channel._trigger('presence',{event:'join',key:n,currentPresences:t,newPresences:s})}),this.onLeave((n,t,s)=>{this.channel._trigger('presence',{event:'leave',key:n,currentPresences:t,leftPresences:s})}),this.onSync(()=>{this.channel._trigger('presence',{event:'sync'})})}static syncState(n,t,s,c){const o=this.cloneDeep(n),f=this.transformState(t),h={},l={};return this.map(o,(n,t)=>{f[n]||(l[n]=t)}),this.map(f,(n,t)=>{const s=o[n];if(s){const c=t.map(n=>n.presence_ref),o=s.map(n=>n.presence_ref),f=t.filter(n=>o.indexOf(n.presence_ref)<0),p=s.filter(n=>c.indexOf(n.presence_ref)<0);f.length>0&&(h[n]=f),p.length>0&&(l[n]=p)}else h[n]=t}),this.syncDiff(o,{joins:h,leaves:l},s,c)}static syncDiff(n,t,s,c){const{joins:o,leaves:f}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return s||(s=()=>{}),c||(c=()=>{}),this.map(o,(t,c)=>{var o;const f=null!==(o=n[t])&&void 0!==o?o:[];if(n[t]=this.cloneDeep(c),f.length>0){const s=n[t].map(n=>n.presence_ref),c=f.filter(n=>s.indexOf(n.presence_ref)<0);n[t].unshift(...c)}s(t,f,c)}),this.map(f,(t,s)=>{let o=n[t];if(!o)return;const f=s.map(n=>n.presence_ref);o=o.filter(n=>f.indexOf(n.presence_ref)<0),n[t]=o,c(t,o,s),0===o.length&&delete n[t]}),n}static map(n,t){return Object.getOwnPropertyNames(n).map(s=>t(s,n[s]))}static transformState(n){return n=this.cloneDeep(n),Object.getOwnPropertyNames(n).reduce((t,s)=>{const c=n[s];return t[s]='metas'in c?c.metas.map(n=>(n.presence_ref=n.phx_ref,delete n.phx_ref,delete n.phx_ref_prev,n)):c,t},{})}static cloneDeep(n){return JSON.parse(JSON.stringify(n))}onJoin(n){this.caller.onJoin=n}onLeave(n){this.caller.onLeave=n}onSync(n){this.caller.onSync=n}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}e.default=t});","lineCount":1,"map":[[1,29,1,0],[1,42,8,0],[1,46,8,4,"REALTIME_PRESENCE_LISTEN_EVENTS"],[1,48,6,0,"Object"],[1,55,6,7,"defineProperty"],[1,70,6,22,"exports"],[1,72,6,31],[1,85,6,45],[1,86,6,47,"value"],[1,93,6,54],[1,97,7,0,"exports"],[1,99,7,8,"REALTIME_PRESENCE_LISTEN_EVENTS"],[1,136,7,39,"undefined"],[1,139,9,0],[1,148,9,11,"REALTIME_PRESENCE_LISTEN_EVENTS"],[1,151,10,4,"REALTIME_PRESENCE_LISTEN_EVENTS"],[1,153,10,42],[1,158,10,46],[1,165,11,4,"REALTIME_PRESENCE_LISTEN_EVENTS"],[1,167,11,42],[1,172,11,46],[1,179,12,4,"REALTIME_PRESENCE_LISTEN_EVENTS"],[1,181,12,43],[1,187,12,47],[1,194,13,1],[1,196,9,0],[1,197,13,3,"REALTIME_PRESENCE_LISTEN_EVENTS"],[1,201,13,39,"exports"],[1,203,13,47,"REALTIME_PRESENCE_LISTEN_EVENTS"],[1,235,13,81,"REALTIME_PRESENCE_LISTEN_EVENTS"],[1,237,13,115],[1,238,13,116],[1,242,14,0],[1,248,14,6,"RealtimePresence"],[1,250,30,4,"constructor"],[1,262,30,16,"channel"],[1,264,30,25,"opts"],[1,267,31,8,"this"],[1,272,31,13,"channel"],[1,280,31,23,"channel"],[1,282,32,8,"this"],[1,287,32,13,"state"],[1,293,32,21],[1,294,32,22],[1,296,33,8,"this"],[1,301,33,13,"pendingDiffs"],[1,314,33,28],[1,317,34,8,"this"],[1,322,34,13,"joinRef"],[1,330,34,23],[1,335,35,8,"this"],[1,340,35,13,"enabled"],[1,349,35,23],[1,351,36,8,"this"],[1,356,36,13,"caller"],[1,363,36,22],[1,364,37,12,"onJoin"],[1,371,37,20,"onJoin"],[1,378,38,12,"onLeave"],[1,386,38,21,"onLeave"],[1,393,39,12,"onSync"],[1,400,39,20,"onSync"],[1,408,41,8],[1,414,41,14,"events"],[1,417,41,24,"opts"],[1,430,41,56,"undefined"],[1,432,41,68,"opts"],[1,434,41,73,"events"],[1,443,41,84],[1,444,42,12,"state"],[1,450,42,19],[1,467,43,12,"diff"],[1,472,43,18],[1,489,45,8,"this"],[1,494,45,13,"channel"],[1,502,45,21,"_on"],[1,506,45,25,"events"],[1,508,45,32,"state"],[1,514,45,39],[1,515,45,40],[1,517,45,44,"newState"],[1,521,46,12],[1,527,46,18,"onJoin"],[1,534,46,20,"onJoin"],[1,536,46,26,"onLeave"],[1,544,46,28,"onLeave"],[1,546,46,35,"onSync"],[1,553,46,37,"onSync"],[1,556,46,48,"this"],[1,561,46,53,"caller"],[1,568,47,12,"this"],[1,573,47,17,"joinRef"],[1,581,47,27,"this"],[1,586,47,32,"channel"],[1,594,47,40,"_joinRef"],[1,605,48,12,"this"],[1,610,48,17,"state"],[1,616,48,25,"RealtimePresence"],[1,618,48,42,"syncState"],[1,628,48,52,"this"],[1,633,48,57,"state"],[1,639,48,64,"newState"],[1,641,48,74,"onJoin"],[1,643,48,82,"onLeave"],[1,646,49,12,"this"],[1,651,49,17,"pendingDiffs"],[1,664,49,30,"forEach"],[1,672,49,39,"diff"],[1,676,50,16,"this"],[1,681,50,21,"state"],[1,687,50,29,"RealtimePresence"],[1,689,50,46,"syncDiff"],[1,698,50,55,"this"],[1,703,50,60,"state"],[1,709,50,67,"diff"],[1,711,50,73,"onJoin"],[1,713,50,81,"onLeave"],[1,718,52,12,"this"],[1,723,52,17,"pendingDiffs"],[1,736,52,32],[1,739,53,12,"onSync"],[1,745,55,8,"this"],[1,750,55,13,"channel"],[1,758,55,21,"_on"],[1,762,55,25,"events"],[1,764,55,32,"diff"],[1,769,55,38],[1,770,55,39],[1,772,55,43,"diff"],[1,776,56,12],[1,782,56,18,"onJoin"],[1,789,56,20,"onJoin"],[1,791,56,26,"onLeave"],[1,799,56,28,"onLeave"],[1,801,56,35,"onSync"],[1,808,56,37,"onSync"],[1,811,56,48,"this"],[1,816,56,53,"caller"],[1,823,57,16,"this"],[1,828,57,21,"inPendingSyncState"],[1,849,58,16,"this"],[1,854,58,21,"pendingDiffs"],[1,867,58,34,"push"],[1,872,58,39,"diff"],[1,876,61,16,"this"],[1,881,61,21,"state"],[1,887,61,29,"RealtimePresence"],[1,889,61,46,"syncDiff"],[1,898,61,55,"this"],[1,903,61,60,"state"],[1,909,61,67,"diff"],[1,911,61,73,"onJoin"],[1,913,61,81,"onLeave"],[1,916,62,16,"onSync"],[1,923,65,8,"this"],[1,928,65,13,"onJoin"],[1,935,65,20],[1,936,65,21,"key"],[1,938,65,26,"currentPresences"],[1,940,65,44,"newPresences"],[1,945,66,12,"this"],[1,950,66,17,"channel"],[1,958,66,25,"_trigger"],[1,967,66,34],[1,978,66,46],[1,979,67,16,"event"],[1,985,67,23],[1,992,68,16,"key"],[1,998,69,16,"currentPresences"],[1,1017,70,16,"newPresences"],[1,1036,73,8,"this"],[1,1041,73,13,"onLeave"],[1,1049,73,21],[1,1050,73,22,"key"],[1,1052,73,27,"currentPresences"],[1,1054,73,45,"leftPresences"],[1,1059,74,12,"this"],[1,1064,74,17,"channel"],[1,1072,74,25,"_trigger"],[1,1081,74,34],[1,1092,74,46],[1,1093,75,16,"event"],[1,1099,75,23],[1,1107,76,16,"key"],[1,1113,77,16,"currentPresences"],[1,1132,78,16,"leftPresences"],[1,1152,81,8,"this"],[1,1157,81,13,"onSync"],[1,1164,81,20],[1,1169,82,12,"this"],[1,1174,82,17,"channel"],[1,1182,82,25,"_trigger"],[1,1191,82,34],[1,1202,82,46],[1,1203,82,48,"event"],[1,1209,82,55],[1,1219,84,4],[1,1220,95,4],[1,1236,95,11,"syncState"],[1,1237,95,21,"currentState"],[1,1239,95,35,"newState"],[1,1241,95,45,"onJoin"],[1,1243,95,53,"onLeave"],[1,1246,96,8],[1,1252,96,14,"state"],[1,1254,96,22,"this"],[1,1259,96,27,"cloneDeep"],[1,1269,96,37,"currentState"],[1,1272,97,14,"transformedState"],[1,1274,97,33,"this"],[1,1279,97,38,"transformState"],[1,1294,97,53,"newState"],[1,1297,98,14,"joins"],[1,1299,98,22],[1,1300,98,23],[1,1302,99,14,"leaves"],[1,1304,99,23],[1,1305,99,24],[1,1307,123,8],[1,1314,100,8,"this"],[1,1319,100,13,"map"],[1,1323,100,17,"state"],[1,1325,100,24],[1,1326,100,25,"key"],[1,1328,100,30,"presences"],[1,1333,101,17,"transformedState"],[1,1335,101,34,"key"],[1,1340,102,16,"leaves"],[1,1342,102,23,"key"],[1,1345,102,30,"presences"],[1,1350,105,8,"this"],[1,1355,105,13,"map"],[1,1359,105,17,"transformedState"],[1,1361,105,35],[1,1362,105,36,"key"],[1,1364,105,41,"newPresences"],[1,1369,106,12],[1,1375,106,18,"currentPresences"],[1,1377,106,37,"state"],[1,1379,106,43,"key"],[1,1382,107,12],[1,1385,107,16,"currentPresences"],[1,1387,107,34],[1,1388,108,16],[1,1394,108,22,"newPresenceRefs"],[1,1396,108,40,"newPresences"],[1,1398,108,53,"map"],[1,1402,108,58,"m"],[1,1405,108,64,"m"],[1,1407,108,66,"presence_ref"],[1,1421,109,22,"curPresenceRefs"],[1,1423,109,40,"currentPresences"],[1,1425,109,57,"map"],[1,1429,109,62,"m"],[1,1432,109,68,"m"],[1,1434,109,70,"presence_ref"],[1,1448,110,22,"joinedPresences"],[1,1450,110,40,"newPresences"],[1,1452,110,53,"filter"],[1,1459,110,61,"m"],[1,1462,110,67,"curPresenceRefs"],[1,1464,110,83,"indexOf"],[1,1472,110,91,"m"],[1,1474,110,93,"presence_ref"],[1,1488,110,109],[1,1491,111,22,"leftPresences"],[1,1493,111,38,"currentPresences"],[1,1495,111,55,"filter"],[1,1502,111,63,"m"],[1,1505,111,69,"newPresenceRefs"],[1,1507,111,85,"indexOf"],[1,1515,111,93,"m"],[1,1517,111,95,"presence_ref"],[1,1531,111,111],[1,1534,112,20,"joinedPresences"],[1,1536,112,36,"length"],[1,1543,112,45],[1,1547,113,20,"joins"],[1,1549,113,26,"key"],[1,1552,113,33,"joinedPresences"],[1,1555,115,20,"leftPresences"],[1,1557,115,34,"length"],[1,1564,115,43],[1,1568,116,20,"leaves"],[1,1570,116,27,"key"],[1,1573,116,34,"leftPresences"],[1,1575,118,12],[1,1581,120,16,"joins"],[1,1583,120,22,"key"],[1,1586,120,29,"newPresences"],[1,1590,123,15,"this"],[1,1595,123,20,"syncDiff"],[1,1604,123,29,"state"],[1,1606,123,36],[1,1607,123,38,"joins"],[1,1615,123,45,"leaves"],[1,1625,123,55,"onJoin"],[1,1627,123,63,"onLeave"],[1,1629,124,4],[1,1630,135,4],[1,1645,135,11,"syncDiff"],[1,1646,135,20,"state"],[1,1648,135,27,"diff"],[1,1650,135,33,"onJoin"],[1,1652,135,41,"onLeave"],[1,1655,136,8],[1,1661,136,14,"joins"],[1,1667,136,16,"joins"],[1,1669,136,21,"leaves"],[1,1676,136,23,"leaves"],[1,1679,136,34],[1,1680,137,12,"joins"],[1,1686,137,19,"this"],[1,1691,137,24,"transformState"],[1,1706,137,39,"diff"],[1,1708,137,44,"joins"],[1,1715,138,12,"leaves"],[1,1722,138,20,"this"],[1,1727,138,25,"transformState"],[1,1742,138,40,"diff"],[1,1744,138,45,"leaves"],[1,1753,168,8],[1,1760,140,13,"onJoin"],[1,1764,141,12,"onJoin"],[1,1766,141,21,"onJoin"],[1,1774,143,13,"onLeave"],[1,1778,144,12,"onLeave"],[1,1780,144,22,"onLeave"],[1,1788,146,8,"this"],[1,1793,146,13,"map"],[1,1797,146,17,"joins"],[1,1799,146,24],[1,1800,146,25,"key"],[1,1802,146,30,"newPresences"],[1,1807,147,12],[1,1811,147,16,"_a"],[1,1813,148,12],[1,1819,148,18,"currentPresences"],[1,1821,148,59],[1,1829,148,38,"_a"],[1,1831,148,43,"state"],[1,1833,148,49,"key"],[1,1843,148,69,"undefined"],[1,1847,148,67,"_a"],[1,1849,148,83,"_a"],[1,1851,148,88],[1,1854,150,12],[1,1857,149,12,"state"],[1,1859,149,18,"key"],[1,1862,149,25,"this"],[1,1867,149,30,"cloneDeep"],[1,1877,149,40,"newPresences"],[1,1880,150,16,"currentPresences"],[1,1882,150,33,"length"],[1,1889,150,42],[1,1891,150,45],[1,1892,151,16],[1,1898,151,22,"joinedPresenceRefs"],[1,1900,151,43,"state"],[1,1902,151,49,"key"],[1,1905,151,54,"map"],[1,1909,151,59,"m"],[1,1912,151,65,"m"],[1,1914,151,67,"presence_ref"],[1,1928,152,22,"curPresences"],[1,1930,152,37,"currentPresences"],[1,1932,152,54,"filter"],[1,1939,152,62,"m"],[1,1942,152,68,"joinedPresenceRefs"],[1,1944,152,87,"indexOf"],[1,1952,152,95,"m"],[1,1954,152,97,"presence_ref"],[1,1968,152,113],[1,1971,153,16,"state"],[1,1973,153,22,"key"],[1,1976,153,27,"unshift"],[1,1987,153,38,"curPresences"],[1,1989,154,12],[1,1990,155,12,"onJoin"],[1,1992,155,19,"key"],[1,1994,155,24,"currentPresences"],[1,1996,155,42,"newPresences"],[1,2001,157,8,"this"],[1,2006,157,13,"map"],[1,2010,157,17,"leaves"],[1,2012,157,25],[1,2013,157,26,"key"],[1,2015,157,31,"leftPresences"],[1,2020,158,12],[1,2024,158,16,"currentPresences"],[1,2026,158,35,"state"],[1,2028,158,41,"key"],[1,2031,159,12],[1,2035,159,17,"currentPresences"],[1,2037,160,16],[1,2044,161,12],[1,2050,161,18,"presenceRefsToRemove"],[1,2052,161,41,"leftPresences"],[1,2054,161,55,"map"],[1,2058,161,60,"m"],[1,2061,161,66,"m"],[1,2063,161,68,"presence_ref"],[1,2077,162,12,"currentPresences"],[1,2079,162,31,"currentPresences"],[1,2081,162,48,"filter"],[1,2088,162,56,"m"],[1,2091,162,62,"presenceRefsToRemove"],[1,2093,162,83,"indexOf"],[1,2101,162,91,"m"],[1,2103,162,93,"presence_ref"],[1,2117,162,109],[1,2120,163,12,"state"],[1,2122,163,18,"key"],[1,2125,163,25,"currentPresences"],[1,2127,164,12,"onLeave"],[1,2129,164,20,"key"],[1,2131,164,25,"currentPresences"],[1,2133,164,43,"leftPresences"],[1,2136,165,44],[1,2140,165,16,"currentPresences"],[1,2142,165,33,"length"],[1,2157,166,23,"state"],[1,2159,166,29,"key"],[1,2164,168,15,"state"],[1,2165,169,4],[1,2166,171,4],[1,2176,171,11,"map"],[1,2177,171,15,"obj"],[1,2179,171,20,"func"],[1,2182,172,8],[1,2189,172,15,"Object"],[1,2196,172,22,"getOwnPropertyNames"],[1,2216,172,42,"obj"],[1,2219,172,47,"map"],[1,2223,172,52,"key"],[1,2226,172,60,"func"],[1,2228,172,65,"key"],[1,2230,172,70,"obj"],[1,2232,172,74,"key"],[1,2236,173,4],[1,2237,197,4],[1,2258,197,11,"transformState"],[1,2259,197,26,"state"],[1,2262,199,8],[1,2269,198,8,"state"],[1,2271,198,16,"this"],[1,2276,198,21,"cloneDeep"],[1,2286,198,31,"state"],[1,2289,199,15,"Object"],[1,2296,199,22,"getOwnPropertyNames"],[1,2316,199,42,"state"],[1,2319,199,49,"reduce"],[1,2326,199,56],[1,2327,199,57,"newState"],[1,2329,199,67,"key"],[1,2334,200,12],[1,2340,200,18,"presences"],[1,2342,200,30,"state"],[1,2344,200,36,"key"],[1,2347,212,12],[1,2354,202,16,"newState"],[1,2356,202,25,"key"],[1,2359,201,16],[1,2369,201,27,"presences"],[1,2371,202,32,"presences"],[1,2373,202,42,"metas"],[1,2379,202,48,"map"],[1,2383,202,53,"presence"],[1,2387,203,20,"presence"],[1,2389,203,43],[1,2402,203,47,"presence"],[1,2404,203,65],[1,2419,204,27,"presence"],[1,2421,204,45],[1,2436,205,27,"presence"],[1,2438,205,50],[1,2451,206,27,"presence"],[1,2455,210,32,"presences"],[1,2457,212,19,"newState"],[1,2460,213,11],[1,2461,213,12],[1,2463,214,4],[1,2464,216,4],[1,2480,216,11,"cloneDeep"],[1,2481,216,21,"obj"],[1,2484,217,8],[1,2491,217,15,"JSON"],[1,2496,217,20,"parse"],[1,2502,217,26,"JSON"],[1,2507,217,31,"stringify"],[1,2517,217,41,"obj"],[1,2520,218,4],[1,2521,220,4,"onJoin"],[1,2528,220,11,"callback"],[1,2531,221,8,"this"],[1,2536,221,13,"caller"],[1,2543,221,20,"onJoin"],[1,2550,221,29,"callback"],[1,2551,222,4],[1,2552,224,4,"onLeave"],[1,2560,224,12,"callback"],[1,2563,225,8,"this"],[1,2568,225,13,"caller"],[1,2575,225,20,"onLeave"],[1,2583,225,30,"callback"],[1,2584,226,4],[1,2585,228,4,"onSync"],[1,2592,228,11,"callback"],[1,2595,229,8,"this"],[1,2600,229,13,"caller"],[1,2607,229,20,"onSync"],[1,2614,229,29,"callback"],[1,2615,230,4],[1,2616,232,4,"inPendingSyncState"],[1,2637,233,8],[1,2644,233,16,"this"],[1,2649,233,21,"joinRef"],[1,2658,233,32,"this"],[1,2663,233,37,"joinRef"],[1,2673,233,49,"this"],[1,2678,233,54,"channel"],[1,2686,233,62,"_joinRef"],[1,2696,234,4],[1,2698,236,0,"exports"],[1,2700,236,8,"default"],[1,2708,236,18,"RealtimePresence"],[1,2709,236,35],[1,2712]],"functionMap":{"names":["<global>","<anonymous>","RealtimePresence","constructor","caller.onJoin","caller.onLeave","caller.onSync","channel._on$argument_2","pendingDiffs.forEach$argument_0","onJoin$argument_0","onLeave$argument_0","onSync$argument_0","syncState","map$argument_1","newPresences.map$argument_0","currentPresences.map$argument_0","newPresences.filter$argument_0","currentPresences.filter$argument_0","syncDiff","onJoin","onLeave","state.key.map$argument_0","leftPresences.map$argument_0","map","Object.getOwnPropertyNames.map$argument_0","transformState","Object.getOwnPropertyNames.reduce$argument_0","presences.metas.map$argument_0","cloneDeep","onSync","inPendingSyncState"],"mappings":"AAA;CCQ;CDI;AEC;ICgB;oBCO,SD;qBEC,SF;oBGC,SH;2CIM;sCCI;aDE;SJG;0CIC;SJS;oBMC;SNO;qBOC;SPO;oBQC;SRE;KDC;IUW;wBCK;SDI;mCCC;yDCG,qBD;6DEC,qBF;4DGC,kDH;8DIC,kDJ;SDW;KVE;IgBW;qBCM,SD;sBEG,SF;wBLE;0DQK,qBR;6DIC,qDJ;SKI;yBLC;2DSI,qBT;uDIC,uDJ;SKK;KhBE;IqBE;mDCC,4BD;KrBC;IuBwB;wDCE;oDCG;iBDK;SDM;KvBC;I0BE;K1BE;IiBE;KjBE;IkBE;KlBE;I2BE;K3BE;I4BE;K5BE;CFC"},"hasCjsExports":true},"type":"js/module"}]}